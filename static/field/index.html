<!DOCTYPE html> 
<html>
    <head>
        <title>Pong!</title> 
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/> 

        <script type="text/javascript" src="/libs/qrcodejs/qrcode.js"></script>

        <script type="text/javascript" src="/libs/jquery/jquery.min.js" ></script>
        <script type="text/javascript" src="/libs/jqueryui/jquery-ui-1.10.3.custom.min.js" ></script>
        <link rel="stylesheet" href="/libs/jqueryui/css/trontastic/jquery-ui.css" type="text/css" /> 

        <script type="text/javascript" src="/config.js" ></script>

        <script src="/socket.io/socket.io.js"></script>
        <script>
            var socket = io.connect('http://' + CONFIG.domain + '/agent');
        </script>

        <style>
            .ui-dialog {
                font-size: 14px;
            }
        </style>

        <script src="./game.js" type="text/javascript"></script> 
        <script src="./pong.js" type="text/javascript"></script>

        <script type="text/javascript">
            (function () {
                Game.ready(function() {
                    $(window).ready(function () {
                        var calcCanvasHeight = function () {
                            return parseInt((95 / 100) * $(window).outerHeight());
                        };

                        var calcCanvasMarginTop = function () {
                            return parseInt((2.5 / 100) * $(window).outerHeight());
                        };

                        $("body").prepend('<canvas id="game" style="margin-top: ' + calcCanvasMarginTop() + 'px; width: 95%; height: ' + calcCanvasHeight() + 'px;"><div id="unsupported">Sorry, this example cannot be run because your browser does not support the &lt;canvas&gt; element</div></canvas>');

                        $(window).resize(function () {
                            $("#game").css({height: calcCanvasHeight(), marginTop: calcCanvasMarginTop()});
                        });

                        pong = Game.start('game', Pong, {
                            sound:             true,
                            stats:             false,
                            footprints:    false,
                            predictions: false
                        });

                        $("#dialog-message").dialog({
                            modal: true,
                            position: ["center", (10 / 100) * $(window).height()],
                            width: 400,
                            buttons: {
                                "Against AI": function() {
                                    socket.emit("start", 1);
                                    pong.start(1);

                                    $( this ).dialog( "close" );
                                },
                                "Against Each Other": function() {
                                    socket.emit("start", 2);
                                    pong.start(2);

                                    $( this ).dialog( "close" );
                                }
                            }
                        });
                    });
                });

                socket.emit("new_field");
                
                socket.on("field_registered", function (field_id) {
                    var controller_url = "http://" + CONFIG.domain + "/r/" + field_id;
                    var $qrcode = $("#qr-code");
                    var qr_size = 250;
                    $qrcode.html("").css({"padding": "10px", "width": qr_size + "px", "background-color": "white", "margin": "15px auto"});
                    new QRCode($qrcode.get(0), {text: controller_url, width: qr_size, height: qr_size, correctLevel: QRCode.CorrectLevel.L});
                    $("#controller_url").html(controller_url);
                });
                
                socket.on("controller_connected", function () {
                    $("#connected_players").html(parseInt($("#connected_players").html(), 10) + 1);
                });
                
                socket.on("controller_disconnected", function () {
                    $("#connected_players").html(parseInt($("#connected_players").html(), 10) - 1);
                });
                
                socket.on("direction", function (side, direction) {
                    paddle = side === 0 ? pong.leftPaddle : pong.rightPaddle;
                
                    if (direction === 1) {
                      paddle.stopMovingDown();
                      paddle.moveUp();
                    } else if (direction === 0) {
                      paddle.stopMovingUp();
                      paddle.stopMovingDown();
                    } else {
                      paddle.stopMovingUp();
                      paddle.moveDown();
                    }
                });
            })();
        </script>
    </head> 
     
    <body style="background-color: black; padding: 0; margin: 0; overflow: auto; text-align: center;"> 
        <div id="dialog-message" title="Multiplayer Pong" style="text-align: center; font-size: 25px;">
            <div id="qr-code">Loading QR Code...</div>
            <span id="controller_url" style="font-weight: bold;"></span><br />
            <div style="text-align: center; margin-top: 10px;">Connected players: <span id="connected_players" style="font-weight: bold;">0</span></div>
        </div>
    </body> 
</html>
